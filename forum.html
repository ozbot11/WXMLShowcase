<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Forum - UW Student Community</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4c1d95 0%, #6366f1 100%);
            color: white;
            padding: 30px 40px;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
        }

        .header-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .auth-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 25px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .login-prompt {
            text-align: center;
            padding: 60px 40px;
            color: #6b7280;
        }

        .login-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .login-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }

        .forum-content {
            padding: 40px;
        }

        .forum-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .search-section {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            background: white;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
        }

        .ask-question-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ask-question-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .ask-question-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .question-form {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #10b981;
        }

        .question-form.show {
            display: block;
            animation: slideDown 0.5s ease;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .submit-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cancel-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #059669;
        }

        .cancel-btn:hover {
            background: #4b5563;
        }

        .questions-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .question-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #6366f1;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .question-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
            min-width: 120px;
        }

        .question-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .question-preview {
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .question-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tag {
            background: #e2e8f0;
            color: #475569;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .tag.math125 { background: #dbeafe; color: #1e40af; }
        .tag.math126 { background: #d1fae5; color: #065f46; }
        .tag.integration { background: #fef3c7; color: #92400e; }
        .tag.geometry { background: #ede9fe; color: #6b21a8; }

        .question-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .author-info {
            color: #6366f1;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .timestamp {
            color: #9ca3af;
            font-size: 0.85rem;
        }

        .votes {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            margin-right: 15px;
        }

        .vote-btn {
            background: none;
            border: 2px solid #e2e8f0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .vote-btn:hover {
            border-color: #6366f1;
            color: #6366f1;
        }

        .vote-btn.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .vote-count {
            font-weight: 600;
            color: #374151;
        }

        .question-content {
            flex: 1;
        }

        .question-body {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #6366f1;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-answered { background: #10b981; }
        .status-unanswered { background: #ef4444; }
        .status-discussing { background: #f59e0b; }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ef4444;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #10b981;
        }

        /* Question Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .question-modal {
            background: white;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 30px;
            border-radius: 15px 15px 0 0;
            position: sticky;
            top: 0;
            z-index: 1001;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .modal-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0.9;
        }

        .modal-author {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-author img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .modal-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            padding: 30px;
        }

        .question-content {
            margin-bottom: 30px;
        }

        .question-body {
            font-size: 1.1rem;
            line-height: 1.7;
            color: #374151;
            margin-bottom: 20px;
        }

        .question-tags-modal {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 30px;
        }

        .question-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid #f1f5f9;
            margin-bottom: 30px;
        }

        .vote-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .vote-btn-large {
            background: none;
            border: 2px solid #e2e8f0;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .vote-btn-large:hover {
            border-color: #6366f1;
            color: #6366f1;
        }

        .vote-btn-large.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .vote-count-large {
            font-weight: 700;
            font-size: 1.2rem;
            color: #374151;
        }

        .answers-section {
            margin-top: 30px;
        }

        .answers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .answers-count {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
        }

        .sort-answers {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .answer-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .answer-item.best-answer {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
        }

        .answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .answer-author {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .answer-author img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }

        .answer-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .best-answer-badge {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .answer-content {
            font-size: 1rem;
            line-height: 1.6;
            color: #374151;
            margin-bottom: 15px;
        }

        .answer-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .answer-vote {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mark-best-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mark-best-btn:hover {
            background: #059669;
        }

        .reply-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
        }

        .reply-header {
            margin-bottom: 20px;
        }

        .reply-header h4 {
            color: #1e293b;
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .reply-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .reply-textarea:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .reply-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .reply-tips {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .reply-submit {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reply-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .reply-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .question-modal {
                margin: 10px;
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1 class="header-title">🎓 Math Forum</h1>
                    <p class="header-subtitle">UW Student Community for Math 125 & 126</p>
                </div>
                <div class="auth-section">
                    <div id="userInfo" class="user-info" style="display: none;">
                        <img id="userAvatar" class="user-avatar" src="" alt="User">
                        <span id="userName"></span>
                        <button class="nav-btn" onclick="signOut()">Sign Out</button>
                    </div>
                    <div id="authButtons" style="display: none;">
                        <a href="index.html" class="nav-btn">← Back to Topics</a>
                        <button class="nav-btn" onclick="signInWithGoogle()">Sign in with Google</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loginPrompt" class="login-prompt">
            <h2>Welcome to the UW Math Forum!</h2>
            <p>Sign in with your UW Google account to ask questions, share knowledge, and connect with fellow students.</p>
            <button class="login-btn" onclick="signInWithGoogle()">
                🔗 Sign in with UW Google Account
            </button>
        </div>

        <div id="forumContent" class="forum-content" style="display: none;">
            <div class="forum-controls">
                <div class="search-section">
                    <input type="text" class="search-input" placeholder="Search questions, topics, or users..." id="searchInput">
                    <select class="filter-select" id="categoryFilter">
                        <option value="all">All Categories</option>
                        <option value="math125">Math 125</option>
                        <option value="math126">Math 126</option>
                        <option value="integration">Integration</option>
                        <option value="geometry">3D Geometry</option>
                        <option value="applications">Applications</option>
                    </select>
                    <select class="filter-select" id="sortFilter">
                        <option value="recent">Most Recent</option>
                        <option value="popular">Most Popular</option>
                        <option value="unanswered">Unanswered</option>
                        <option value="answered">Answered</option>
                    </select>
                </div>
                <button class="ask-question-btn" onclick="showQuestionForm()" id="askBtn">Ask Question</button>
            </div>

            <div id="messages"></div>

            <div class="question-form" id="questionForm">
                <h3 style="margin-bottom: 20px; color: #1e293b;">Ask a New Question</h3>
                <form id="newQuestionForm">
                    <div class="form-group">
                        <label for="questionTitle">Question Title *</label>
                        <input type="text" id="questionTitle" placeholder="What's your question about?" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="questionCategory">Category *</label>
                        <select id="questionCategory" required>
                            <option value="">Select a category...</option>
                            <option value="math125">Math 125 - Calculus I</option>
                            <option value="math126">Math 126 - Calculus II</option>
                            <option value="integration">Integration Techniques</option>
                            <option value="geometry">3D Geometry</option>
                            <option value="applications">Real-World Applications</option>
                            <option value="study-tips">Study Tips & Resources</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="questionBody">Detailed Question *</label>
                        <textarea id="questionBody" placeholder="Describe your question in detail. Include any specific problems, concepts you're struggling with, or context that might help others understand what you need help with." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="questionTags">Tags (optional)</label>
                        <input type="text" id="questionTags" placeholder="Add tags separated by commas (e.g., volume, integration, paraboloid)">
                    </div>
                    
                    <div class="form-buttons">
                        <button type="button" class="cancel-btn" onclick="hideQuestionForm()">Cancel</button>
                        <button type="submit" class="submit-btn">Post Question</button>
                    </div>
                </form>
            </div>

            <div id="questionsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading questions...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Detail Modal -->
    <div class="modal-overlay" id="questionModal">
        <div class="question-modal">
            <div class="modal-header">
                <button class="close-modal" onclick="closeQuestionModal()">&times;</button>
                <h2 class="modal-title" id="modalQuestionTitle">Loading...</h2>
                <div class="modal-meta">
                    <div class="modal-author" id="modalQuestionAuthor">
                        <img src="" alt="Author" id="modalAuthorImage">
                        <div>
                            <div id="modalAuthorName">Loading...</div>
                            <div id="modalQuestionDate" style="font-size: 0.9rem; opacity: 0.8;">Loading...</div>
                        </div>
                    </div>
                    <div class="modal-stats" id="modalQuestionStats">
                        <span>👀 0 views</span>
                        <span>💬 0 answers</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-body">
                <div class="question-content">
                    <div class="question-body" id="modalQuestionBody">Loading question content...</div>
                    <div class="question-tags-modal" id="modalQuestionTags"></div>
                </div>
                
                <div class="question-actions">
                    <div class="vote-section">
                        <button class="vote-btn-large" id="modalUpvoteBtn" onclick="voteQuestionModal(1)">▲</button>
                        <span class="vote-count-large" id="modalVoteCount">0</span>
                        <button class="vote-btn-large" id="modalDownvoteBtn" onclick="voteQuestionModal(-1)">▼</button>
                    </div>
                    <div>
                        <span id="modalQuestionCategory" class="tag"></span>
                    </div>
                </div>
                
                <div class="answers-section">
                    <div class="answers-header">
                        <h3 class="answers-count" id="answersCount">0 Answers</h3>
                        <select class="sort-answers" id="sortAnswers" onchange="loadAnswers()">
                            <option value="votes">Most Voted</option>
                            <option value="recent">Most Recent</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>
                    
                    <div id="answersList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading answers...</p>
                        </div>
                    </div>
                </div>
                
                <div class="reply-section" id="replySection" style="display: none;">
                    <div class="reply-header">
                        <h4>💬 Your Answer</h4>
                        <p style="color: #6b7280; font-size: 0.9rem;">Help your fellow students by sharing your knowledge!</p>
                    </div>
                    
                    <form id="answerForm">
                        <textarea 
                            class="reply-textarea" 
                            id="answerText" 
                            placeholder="Write your answer here... Explain the concept, show your work, or provide helpful insights."
                            required>
                        </textarea>
                        
                        <div class="reply-actions">
                            <div class="reply-tips">
                                💡 <strong>Tips:</strong> Include step-by-step explanations, cite sources, be respectful
                            </div>
                            <button type="submit" class="reply-submit" id="submitAnswer">Post Answer</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 🔥 FIREBASE CONFIGURATION
        const firebaseConfig = {
        apiKey: "AIzaSyAEXNhi84tJqxOK5Wh0aRqQqEgIi_8CllA",
        authDomain: "visual-joy.firebaseapp.com",
        projectId: "visual-joy",
        storageBucket: "visual-joy.firebasestorage.app",
        messagingSenderId: "497956678779",
        appId: "1:497956678779:web:259ddf03c5c416bdf186de",
        measurementId: "G-8DY883EF30"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let unsubscribeQuestions = null;

        // 🔐 AUTHENTICATION
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                showForumContent();
                loadQuestions();
                updateUserProfile(user);
            } else {
                showLoginPrompt();
            }
        });

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({
                hd: 'uw.edu' // Restrict to UW domain
            });
            
            auth.signInWithPopup(provider).catch(error => {
                console.error('Sign in error:', error);
                showMessage('Sign in failed. Please try again.', 'error');
            });
        }

        function signOut() {
            auth.signOut();
        }

        function showLoginPrompt() {
            document.getElementById('loginPrompt').style.display = 'block';
            document.getElementById('forumContent').style.display = 'none';
            document.getElementById('authButtons').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'none';
        }

        function showForumContent() {
            document.getElementById('loginPrompt').style.display = 'none';
            document.getElementById('forumContent').style.display = 'block';
            document.getElementById('authButtons').style.display = 'none';
            document.getElementById('userInfo').style.display = 'flex';
        }

        function updateUserProfile(user) {
            document.getElementById('userName').textContent = user.displayName || user.email;
            document.getElementById('userAvatar').src = user.photoURL || 'https://via.placeholder.com/32';
            
            // Create/update user profile in Firestore
            db.collection('users').doc(user.uid).set({
                name: user.displayName || user.email,
                email: user.email,
                photoURL: user.photoURL,
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }

        // 📝 QUESTION MANAGEMENT
        function loadQuestions() {
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading questions...</p></div>';

            // Real-time listener for questions
            unsubscribeQuestions = db.collection('questions')
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    const questions = [];
                    snapshot.forEach(doc => {
                        questions.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    displayQuestions(questions);
                }, error => {
                    console.error('Error loading questions:', error);
                    showMessage('Error loading questions. Please refresh the page.', 'error');
                });
        }

        function displayQuestions(questions) {
            const questionsContainer = document.getElementById('questionsContainer');
            
            if (questions.length === 0) {
                questionsContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No questions found. Be the first to ask!</p>';
                return;
            }

            questionsContainer.innerHTML = questions.map(question => createQuestionHTML(question)).join('');
        }

        function createQuestionHTML(question) {
            const createdAt = question.createdAt ? question.createdAt.toDate() : new Date();
            const timeAgo = getTimeAgo(createdAt);
            
            return `
                <div class="question-card" onclick="openQuestion('${question.id}')">
                    <div class="question-body">
                        <div class="votes">
                            <button class="vote-btn" onclick="event.stopPropagation(); voteQuestion('${question.id}', 1)">▲</button>
                            <span class="vote-count">${question.votes || 0}</span>
                            <button class="vote-btn" onclick="event.stopPropagation(); voteQuestion('${question.id}', -1)">▼</button>
                        </div>
                        <div class="question-content">
                            <div class="question-header">
                                <div>
                                    <h3 class="question-title">
                                        <span class="status-indicator ${question.answers > 0 ? 'status-answered' : 'status-unanswered'}"></span>
                                        ${question.title}
                                    </h3>
                                    <div class="question-tags">
                                        <span class="tag ${question.category}">${getCategoryName(question.category)}</span>
                                        ${(question.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                                    </div>
                                </div>
                                <div class="question-meta">
                                    <div class="author-info">${question.authorName || 'Anonymous'}</div>
                                    <div class="timestamp">${timeAgo}</div>
                                </div>
                            </div>
                            <p class="question-preview">${question.body.substring(0, 200)}${question.body.length > 200 ? '...' : ''}</p>
                            <div class="question-stats">
                                <span class="stat-item">💬 ${question.answers || 0} answers</span>
                                <span class="stat-item">👀 ${question.views || 0} views</span>
                                <span class="stat-item">⭐ ${question.votes || 0} votes</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function submitQuestion(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showMessage('Please sign in to ask a question.', 'error');
                return;
            }

            const title = document.getElementById('questionTitle').value;
            const category = document.getElementById('questionCategory').value;
            const body = document.getElementById('questionBody').value;
            const tagText = document.getElementById('questionTags').value;
            const tags = tagText ? tagText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

            try {
                await db.collection('questions').add({
                    title,
                    body,
                    category,
                    tags,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email,
                    authorPhoto: currentUser.photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    votes: 0,
                    answers: 0,
                    views: 0
                });

                hideQuestionForm();
                showMessage('Question posted successfully!', 'success');
                document.getElementById('newQuestionForm').reset();
            } catch (error) {
                console.error('Error posting question:', error);
                showMessage('Error posting question. Please try again.', 'error');
            }
        }

        async function voteQuestion(questionId, direction) {
            if (!currentUser) {
                showMessage('Please sign in to vote.', 'error');
                return;
            }

            try {
                const questionRef = db.collection('questions').doc(questionId);
                await db.runTransaction(async (transaction) => {
                    const questionDoc = await transaction.get(questionRef);
                    if (!questionDoc.exists) {
                        throw new Error('Question does not exist!');
                    }

                    const currentVotes = questionDoc.data().votes || 0;
                    transaction.update(questionRef, {
                        votes: currentVotes + direction
                    });
                });
            } catch (error) {
                console.error('Error voting:', error);
                showMessage('Error voting. Please try again.', 'error');
            }
        }

        function openQuestion(questionId) {
            // Increment view count
            db.collection('questions').doc(questionId).update({
                views: firebase.firestore.FieldValue.increment(1)
            });

            // Load and show question details
            showQuestionModal(questionId);
        }

        // 🛠️ UTILITY FUNCTIONS
        function showQuestionForm() {
            if (!currentUser) {
                showMessage('Please sign in to ask a question.', 'error');
                return;
            }
            document.getElementById('questionForm').classList.add('show');
            document.getElementById('questionTitle').focus();
        }

        function hideQuestionForm() {
            document.getElementById('questionForm').classList.remove('show');
        }

        function getCategoryName(category) {
            const categories = {
                'math125': 'Math 125',
                'math126': 'Math 126',
                'integration': 'Integration',
                'geometry': '3D Geometry',
                'applications': 'Applications',
                'study-tips': 'Study Tips'
            };
            return categories[category] || category;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            const intervals = [
                { label: 'year', seconds: 31536000 },
                { label: 'month', seconds: 2592000 },
                { label: 'week', seconds: 604800 },
                { label: 'day', seconds: 86400 },
                { label: 'hour', seconds: 3600 },
                { label: 'minute', seconds: 60 }
            ];
            
            for (const interval of intervals) {
                const count = Math.floor(diffInSeconds / interval.seconds);
                if (count >= 1) {
                    return `${count} ${interval.label}${count > 1 ? 's' : ''} ago`;
                }
            }
            
            return 'Just now';
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Event listeners
        document.getElementById('newQuestionForm').addEventListener('submit', submitQuestion);

        // Clean up listeners when page unloads
        window.addEventListener('beforeunload', () => {
            if (unsubscribeQuestions) {
                unsubscribeQuestions();
            }
        });

        // 📋 QUESTION MODAL FUNCTIONALITY
        let currentQuestionId = null;
        let unsubscribeAnswers = null;

        async function showQuestionModal(questionId) {
            currentQuestionId = questionId;
            const modal = document.getElementById('questionModal');
            
            try {
                // Load question details
                const questionDoc = await db.collection('questions').doc(questionId).get();
                if (!questionDoc.exists) {
                    showMessage('Question not found.', 'error');
                    return;
                }

                const question = { id: questionDoc.id, ...questionDoc.data() };
                populateQuestionModal(question);
                
                // Load answers
                loadAnswers();
                
                // Show modal
                modal.classList.add('show');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
                // Show reply section if user is logged in
                const replySection = document.getElementById('replySection');
                if (currentUser) {
                    replySection.style.display = 'block';
                } else {
                    replySection.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading question:', error);
                showMessage('Error loading question details.', 'error');
            }
        }

        function populateQuestionModal(question) {
            document.getElementById('modalQuestionTitle').textContent = question.title;
            document.getElementById('modalQuestionBody').textContent = question.body;
            document.getElementById('modalVoteCount').textContent = question.votes || 0;
            
            // Author info
            document.getElementById('modalAuthorName').textContent = question.authorName || 'Anonymous';
            document.getElementById('modalAuthorImage').src = question.authorPhoto || 'https://via.placeholder.com/32';
            
            // Date
            const createdAt = question.createdAt ? question.createdAt.toDate() : new Date();
            document.getElementById('modalQuestionDate').textContent = getTimeAgo(createdAt);
            
            // Stats
            document.getElementById('modalQuestionStats').innerHTML = `
                <span>👀 ${question.views || 0} views</span>
                <span>💬 ${question.answers || 0} answers</span>
                <span>⭐ ${question.votes || 0} votes</span>
            `;
            
            // Category
            document.getElementById('modalQuestionCategory').textContent = getCategoryName(question.category);
            document.getElementById('modalQuestionCategory').className = `tag ${question.category}`;
            
            // Tags
            const tagsContainer = document.getElementById('modalQuestionTags');
            tagsContainer.innerHTML = (question.tags || []).map(tag => 
                `<span class="tag">${tag}</span>`
            ).join('');
        }

        function loadAnswers() {
            const answersList = document.getElementById('answersList');
            const sortBy = document.getElementById('sortAnswers').value;
            
            answersList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading answers...</p></div>';
            
            // Clean up previous listener
            if (unsubscribeAnswers) {
                unsubscribeAnswers();
            }
            
            // Set up real-time listener for answers - start with basic query
            let query = db.collection('answers').where('questionId', '==', currentQuestionId);
            
            unsubscribeAnswers = query.onSnapshot(snapshot => {
                const answers = [];
                snapshot.forEach(doc => {
                    answers.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort answers client-side to avoid index requirements
                const sortedAnswers = sortAnswersClientSide(answers, sortBy);
                
                displayAnswers(sortedAnswers);
                updateAnswersCount(sortedAnswers.length);
            }, error => {
                console.error('Error loading answers:', error);
                answersList.innerHTML = '<p style="text-align: center; color: #ef4444;">Error loading answers. Please try refreshing.</p>';
            });
        }

        function sortAnswersClientSide(answers, sortBy) {
            switch (sortBy) {
                case 'votes':
                    return answers.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                case 'recent':
                    return answers.sort((a, b) => {
                        const timeA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                        const timeB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                        return timeB - timeA;
                    });
                case 'oldest':
                    return answers.sort((a, b) => {
                        const timeA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                        const timeB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                        return timeA - timeB;
                    });
                default:
                    return answers;
            }
        }

        function displayAnswers(answers) {
            const answersList = document.getElementById('answersList');
            
            if (answers.length === 0) {
                answersList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <h4>No answers yet</h4>
                        <p>Be the first to help with this question!</p>
                    </div>
                `;
                return;
            }
            
            answersList.innerHTML = answers.map(answer => createAnswerHTML(answer)).join('');
        }

        function createAnswerHTML(answer) {
            const createdAt = answer.createdAt ? answer.createdAt.toDate() : new Date();
            const timeAgo = getTimeAgo(createdAt);
            const isBestAnswer = answer.isBest || false;
            
            return `
                <div class="answer-item ${isBestAnswer ? 'best-answer' : ''}">
                    <div class="answer-header">
                        <div class="answer-author">
                            <img src="${answer.authorPhoto || 'https://via.placeholder.com/28'}" alt="Author">
                            <div>
                                <strong>${answer.authorName || 'Anonymous'}</strong>
                                ${isBestAnswer ? '<span class="best-answer-badge">✅ Best Answer</span>' : ''}
                            </div>
                        </div>
                        <div class="answer-meta">
                            <span>${timeAgo}</span>
                            ${canMarkBestAnswer(answer) ? `<button class="mark-best-btn" onclick="markBestAnswer('${answer.id}')">Mark as Best</button>` : ''}
                        </div>
                    </div>
                    
                    <div class="answer-content">${answer.content}</div>
                    
                    <div class="answer-actions">
                        <div class="answer-vote">
                            <button class="vote-btn" onclick="voteAnswer('${answer.id}', 1)">▲</button>
                            <span class="vote-count">${answer.votes || 0}</span>
                            <button class="vote-btn" onclick="voteAnswer('${answer.id}', -1)">▼</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function canMarkBestAnswer(answer) {
            // Only question author can mark best answers, and only if it's not already marked
            // You'd need to track question ownership for this
            return false; // Simplified for now
        }

        function updateAnswersCount(count) {
            document.getElementById('answersCount').textContent = `${count} Answer${count !== 1 ? 's' : ''}`;
        }

        async function voteQuestionModal(direction) {
            if (!currentUser) {
                showMessage('Please sign in to vote.', 'error');
                return;
            }
            
            try {
                const questionRef = db.collection('questions').doc(currentQuestionId);
                await db.runTransaction(async (transaction) => {
                    const questionDoc = await transaction.get(questionRef);
                    if (!questionDoc.exists) {
                        throw new Error('Question does not exist!');
                    }

                    const currentVotes = questionDoc.data().votes || 0;
                    transaction.update(questionRef, {
                        votes: currentVotes + direction
                    });
                });
                
                // Update the display
                const voteCountElement = document.getElementById('modalVoteCount');
                const currentCount = parseInt(voteCountElement.textContent);
                voteCountElement.textContent = currentCount + direction;
                
            } catch (error) {
                console.error('Error voting:', error);
                showMessage('Error voting. Please try again.', 'error');
            }
        }

        async function voteAnswer(answerId, direction) {
            if (!currentUser) {
                showMessage('Please sign in to vote.', 'error');
                return;
            }

            try {
                const answerRef = db.collection('answers').doc(answerId);
                await db.runTransaction(async (transaction) => {
                    const answerDoc = await transaction.get(answerRef);
                    if (!answerDoc.exists) {
                        throw new Error('Answer does not exist!');
                    }

                    const currentVotes = answerDoc.data().votes || 0;
                    transaction.update(answerRef, {
                        votes: currentVotes + direction
                    });
                });
            } catch (error) {
                console.error('Error voting on answer:', error);
                showMessage('Error voting. Please try again.', 'error');
            }
        }

        async function submitAnswer(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showMessage('Please sign in to post an answer.', 'error');
                return;
            }

            const answerText = document.getElementById('answerText').value.trim();
            if (!answerText) {
                showMessage('Please write an answer before submitting.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitAnswer');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Posting...';

            try {
                // Add answer to database
                await db.collection('answers').add({
                    questionId: currentQuestionId,
                    content: answerText,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email,
                    authorPhoto: currentUser.photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    votes: 0,
                    isBest: false
                });

                // Update question answer count
                await db.collection('questions').doc(currentQuestionId).update({
                    answers: firebase.firestore.FieldValue.increment(1)
                });

                // Clear form and show success
                document.getElementById('answerText').value = '';
                showMessage('Answer posted successfully!', 'success');
                
            } catch (error) {
                console.error('Error posting answer:', error);
                showMessage('Error posting answer. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Post Answer';
            }
        }

        function closeQuestionModal() {
            const modal = document.getElementById('questionModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto'; // Restore scrolling
            
            // Clean up
            if (unsubscribeAnswers) {
                unsubscribeAnswers();
                unsubscribeAnswers = null;
            }
            currentQuestionId = null;
        }

        // Event listeners for modal
        document.getElementById('answerForm').addEventListener('submit', submitAnswer);

        // Close modal when clicking outside
        document.getElementById('questionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeQuestionModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('questionModal').classList.contains('show')) {
                closeQuestionModal();
            }
        });
    </script>
</body>
</html>